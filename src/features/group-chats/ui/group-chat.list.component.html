<aside class="w-64 h-full bg-gray-100 text-black flex flex-col dark:bg-gray-900 dark:text-gray-200">
  <div class="p-4 border border-white dark:border-transparent flex items-center justify-between">
    <shared-search-input
      [query]="searchQuery"
      (queryChange)="searchQuery = $event; onSearchChange()"
      (clear)="clearSearch()"
      [placeholder]="searchPlaceholder"
    ></shared-search-input>
    <button 
      class="w-10 h-10 bg-transparent border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 rounded-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 hover:border-blue-500 hover:text-blue-500 transition-all duration-200 flex-shrink-0 ml-2" 
      (click)="openCreateGroupModal()"
      title="Create Group"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </div>

  <div *ngIf="showCreateGroupModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeCreateGroupModal()">
    <app-toast></app-toast>
    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-96 max-w-md mx-4 transform transition-all duration-300 max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-white">Create Group</h2>
      
      <form (ngSubmit)="createGroup()" class="space-y-6">
        <div class="flex flex-col items-center mb-6">
          <div class="relative w-20 h-20 rounded-full bg-gradient-to-br from-blue-100 to-indigo-200 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center mb-4 overflow-hidden border-4 border-white dark:border-gray-700 shadow-lg">
            <img *ngIf="selectedImageUrl" [src]="selectedImageUrl" alt="Group Avatar" class="w-full h-full object-cover">
            <svg *ngIf="!selectedImageUrl" class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            
            <label
              *ngIf="selectedImageUrl"
              for="fileInput"
              class="absolute inset-0 bg-black bg-opacity-40 dark:bg-opacity-60 rounded-full flex flex-col items-center justify-center
                     text-white opacity-0 hover:opacity-100 cursor-pointer transition-opacity duration-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 mb-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 7h4l3-3h4l3 3h4v12H3V7z"
                />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 13a4 4 0 01-8 0" />
              </svg>
              <span class="text-xs select-none">Change</span>
            </label>
          </div>
        </div>
  
        <app-input
          [(ngModel)]="formData.GroupName"
          name="groupName"
          placeholder="Group Name"
          [required]="true"
          [errors]="getFieldErrors('groupName')"
          class="mb-4"
        ></app-input>
  
        <app-input
          [(ngModel)]="formData.Description"
          name="groupDescription"
          placeholder="Group Description"
          [required]="true"
          [errors]="getFieldErrors('groupDescription')"
          class="mb-4"
        ></app-input>

        <div class="mb-2">
          <div class="relative border border-gray-300 rounded-lg dark: border-gray-700">
            <shared-search-input
              [query]="userSearchQuery"
              (queryChange)="onUserSearchQueryChange($event)"
              (clear)="userSearchQuery = ''; findUserStore.clearUser(); isUserSearchActive = false"
              [placeholder]="'Search users...'"
              (focus)="onUserSearchFocus()"
            ></shared-search-input>

            <div *ngIf="userSearchQuery.trim() && isUserSearchActive" class="absolute top-full left-0 right-0 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-10 mt-1 max-h-40 overflow-y-auto">
              <ng-container *ngIf="user$ | async as user; else noUserFound">
                <div
                  class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition flex items-center gap-3"
                  (click)="addUserToGroup(user.nickName, user.image)"
                >
                  <img
                    [src]="user.image"
                    alt="Avatar"
                    class="w-8 h-8 rounded-full object-cover"
                  />
                  <span class="font-medium text-gray-800 dark:text-gray-200">{{ user.nickName }}</span>
                </div>
              </ng-container>
              <ng-template #noUserFound>
                <div class="p-3 text-center text-gray-500 dark:text-gray-400">
                  User not found
                </div>
              </ng-template>
            </div>
          </div>

          <div *ngIf="selectedUsers.length > 0" class="mt-3">
            <div class="flex flex-wrap gap-2">
              <div
                *ngFor="let user of selectedUsers"
                class="inline-flex items-center gap-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm"
              >
                <img
                  [src]="user.image"
                  alt="Avatar"
                  class="w-5 h-5 rounded-full object-cover"
                />
                <span>{{ user.nickName }}</span>
                <button
                  type="button"
                  (click)="removeUserFromGroup(user.nickName)"
                  class="ml-1 text-blue-600 dark:text-blue-300 hover:text-blue-800 dark:hover:text-blue-100 focus:outline-none"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="getFieldErrors('groupMembers').length > 0" class="mt-2">
            <div *ngFor="let error of getFieldErrors('groupMembers')" class="text-red-500 text-sm">
              {{ error }}
            </div>
          </div>
        </div>
  
        <input
          #fileInput
          id="fileInput"
          (change)="onFileChange($event)"
          type="file"
          accept="image/*"
          name="image"
          class="hidden"
        />
        
        <button
          *ngIf="!selectedImageUrl"
          type="button"
          (click)="fileInput.click()"
          class="w-full px-6 py-4 rounded-2xl text-center mb-6
                 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600
                 text-gray-700 dark:text-gray-300
                 border-2 border-dashed border-gray-300 dark:border-gray-600
                 hover:border-blue-400 dark:hover:border-blue-500
                 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 dark:hover:from-gray-600 dark:hover:to-gray-500
                 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                 transition-all duration-300 transform hover:scale-[1.02]
                 font-medium"
        >
          <svg class="w-5 h-5 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Group Avatar
        </button>
    
        <button 
          type="submit" 
          class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold py-4 rounded-2xl 
                 hover:from-blue-600 hover:to-indigo-700 
                 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                 transform transition-all duration-300 hover:scale-[1.02] 
                 shadow-lg hover:shadow-xl
                 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        >
          Create Group
        </button>
      </form>
    </div>
  </div>

  <ng-container *ngIf="searchQuery && searchResults.length > 0 && image; else fallback">
    <div class="flex-1 overflow-y-auto p-2">
      <div
        *ngFor="let result of searchResults"
        (click)="startChat(result, image)"
        class="p-2 hover:bg-gray-300 rounded-xl cursor-pointer transition flex items-center gap-2 dark:hover:bg-gray-800"
      >
        <span class="text-blue-400">ðŸ”Ž</span>
        <span class="font-medium">{{ result }}</span>
      </div>
    </div>
  </ng-container>

  <ng-template #fallback>
    <ng-container *ngIf="loading$ | async; else notLoading">
      <div class="flex-grow flex items-center justify-center text-gray-500">
        Loading...
      </div>
    </ng-container>

    <ng-template #notLoading>
      <ng-container *ngIf="error$ | async as error; else showChats">
        <div class="flex-grow flex items-center justify-center text-red-500 px-4">
          Error: {{ error }}
        </div>
      </ng-container>
    </ng-template>

    <ng-template #showChats>
      <ul class="flex-grow overflow-y-auto border border-white dark:border-transparent">
        <li *ngIf="(chats$ | async)?.length === 0" class="p-4 text-center text-black dark:text-gray-500">
          {{ emptyListText }}
        </li>

        <shared-chat-list-item
          *ngFor="let chat of chats$ | async"
          [name]="getChatName(chat)"
          [image]="chat.image"
          [active]="selectedNickname === getChatName(chat)"
          (click)="onSelectGroupChat(getChatName(chat), chat.image, chat.groupId || '')"
        ></shared-chat-list-item>
      </ul>
    </ng-template>
  </ng-template>
</aside>