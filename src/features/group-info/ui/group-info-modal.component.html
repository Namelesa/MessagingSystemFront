<div *ngIf="open"
     class="fixed inset-0 z-[99999] flex items-center justify-center"
     style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.5);"
     (click)="onClose()">
  <div
    class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-96 max-w-md mx-4 relative z-[100000]"
    (click)="$event.stopPropagation()">
    
    <app-toast></app-toast>
    
    <app-modal-header
      [title]="getModalTitle()"
      [showEditButton]="!isEditing && !isMembersMode"
      [showSaveButton]="(isEditing && !isMembersMode) || isMembersMode"
      [showCancelButton]="isEditing || isMembersMode"
      [saveDisabled]="isMembersMode && selectedUsers.length === 0"
      (editClick)="toggleEdit()"
      (saveClick)="handleSave()"
      (cancelClick)="handleCancel()">
    </app-modal-header>

    <div *ngIf="loading" class="text-center py-4 mt-16">Loading...</div>
    <div *ngIf="error && !loading" class="text-red-500 text-center py-4 mt-16">{{ error }}</div>

    <div *ngIf="groupInfo && !loading && !error" class="mt-4">
      
      <div class="flex justify-center mb-4">
        <app-avatar
          [src]="groupInfo.image"
          alt="Group Avatar"
          size="md"
          [editable]="isEditing && !isMembersMode"
          inputId="groupAvatarInput"
          (fileChange)="onAvatarChange($event)">
        </app-avatar>
      </div>

      <div *ngIf="!isMembersMode">
        <div class="mb-2">
          <b>Group Name: </b>
          <ng-container *ngIf="!isEditing; else nameEdit">{{ groupInfo.groupName }}</ng-container>
          <ng-template #nameEdit>
            <app-input
              [(ngModel)]="editableGroup.GroupName"
              name="groupName"
              [errors]="getFieldErrors('groupName')"
              placeholder="Group Name"
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2">
          <b>Description: </b>
          <ng-container *ngIf="!isEditing; else descriptionEdit">{{ groupInfo.description }}</ng-container>
          <ng-template #descriptionEdit>
            <app-input
              [(ngModel)]="editableGroup.Description"
              name="description"
              [errors]="getFieldErrors('description')"
              placeholder="Group Description"
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2" *ngIf="!isEditing">
          <b>Admin: </b> {{ groupInfo.admin }}
        </div>
      </div>

<div class="mb-2" *ngIf="!isEditing || isMembersMode">
  <div class="flex items-center justify-between mb-2">
    <b>Members:</b>
    <button
      *ngIf="!isEditing && !isMembersMode && groupInfo.admin === currentUserNickname"
      (click)="enterMembersMode()"
      class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-600 transition text-sm">
      ‚ûï
    </button>
  </div>

  <div *ngIf="isMembersMode" class="mb-3">
    <input
      type="text"
      [(ngModel)]="userSearchQuery"
      (ngModelChange)="onSearchChange($event)"
      placeholder="Search users..."
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
    />

    <div class="mt-2">
      <div *ngIf="userSuggestions.length > 0"
           class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg max-h-40 overflow-y-auto shadow-lg">
        <div *ngFor="let user of userSuggestions"
             (click)="addUserToSelection(user)"
             class="px-3 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center">
          <img [src]="user.image" alt="avatar" class="w-6 h-6 rounded-full mr-2" />
          <span class="text-gray-900 dark:text-white">{{ user.nickName }}</span>
        </div>
      </div>
      
      <div *ngIf="showNotFoundMessage" 
           class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">
        User not found ;(
      </div>
    </div>

    <app-selected-users
      [users]="selectedUsers"
      (removeUser)="removeUserFromSelection($event)">
    </app-selected-users>
  </div>

  <app-user-list
    *ngIf="groupInfo && groupInfo.members"
    [users]="groupInfo.members"
    [adminNickname]="groupInfo.admin"
    [currentUserNickname]="currentUserNickname"
    [showRemoveButtons]="isMembersMode"
    [variant]="isMembersMode ? 'detailed' : 'simple'"
    (removeUser)="removeUserFromSelection($event)"
    (userClick)="onUserClick($event)">
  </app-user-list>
</div>
    </div>
    
    <div *ngIf="isEditing && !isMembersMode && groupInfo?.admin === currentUserNickname" class="pt-2">
      <button
        type="button"
        (click)="deleteGroupInfo()"
        class="w-full py-3 text-sm font-semibold rounded-xl border border-red-600 text-red-600 
               hover:bg-red-600 hover:text-white transition-colors duration-300 dark:border-red-500 dark:text-red-400 dark:hover:bg-red-500">
        üóëÔ∏è Delete Group
      </button>
    </div>
  </div>
</div>