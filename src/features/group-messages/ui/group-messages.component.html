<div #scrollContainer (scroll)="onScroll()" class="overflow-y-auto h-full relative scroll-smooth">
  <ng-container *ngFor="let group of groupedMessages">
    <div class="flex justify-center my-4">
      <span class="inline-block bg-gray-400 text-white px-3 py-1 rounded-full opacity-80 text-sm dark:bg-gray-500 dark:text-white shadow-md">
        {{ isToday(group.messages[0].sendTime) ? 'Today' : (group.messages[0].sendTime | date:'d MMMM yyyy') }}
      </span>
    </div>
    <ng-container *ngFor="let msg of group.messages; let i = index">
      <div class="flex flex-col mb-1 relative" [ngClass]="isMyMessage(msg) ? 'items-end' : 'items-start'">
        <div class="relative max-w-[75%]">
          <div
            class="px-3 py-2 rounded-2xl shadow-sm text-sm min-w-[48px] min-h-[32px]"
            [ngClass]="isMyMessage(msg)
              ? 'ml-auto bg-blue-500 text-white rounded-br-md'
              : 'mr-auto bg-gray-200 text-gray-900 dark:bg-gray-600 dark:text-white rounded-bl-md'"
            style="word-break: break-word;"
          >
            <div *ngIf="!isMyMessage(msg) && shouldShowSenderName(group.messages, i)" 
                 class="text-xs mb-1 text-left font-bold text-gray-700 dark:text-gray-200">
              {{ msg.sender }}
            </div>
            <div class="whitespace-pre-line break-words">{{ msg.content }}</div>
            <div class="flex items-center gap-1 mt-1 text-xs justify-end"
              [ngClass]="isMyMessage(msg)
                ? 'text-blue-200 dark:text-gray-200'
                : 'text-gray-500 dark:text-gray-200'">
              <span>{{ msg.sendTime | date:'shortTime' }}</span>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>