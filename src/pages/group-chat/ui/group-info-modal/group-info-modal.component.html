<div *ngIf="open"
     class="fixed inset-0 z-[99999] flex items-center justify-center"
     style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.5);"
     (click)="onClose()">
  <div
    class="p-8 rounded-2xl shadow-2xl w-96 max-w-md mx-4 relative z-[100000]"
    style="background-color: var(--bg-secondary);"
    (click)="$event.stopPropagation()">
    
    
    <app-modal-header
      [title]="getModalTitle() | translate"
      [showEditButton]="!isEditing && !isMembersMode"
      [showSaveButton]="(isEditing && !isMembersMode) || isMembersMode"
      [showCancelButton]="isEditing || isMembersMode"
      [saveDisabled]="!canSave"
      (editClick)="toggleEdit()"
      (saveClick)="handleSave()"
      (cancelClick)="handleCancel()">
    </app-modal-header>

    <div *ngIf="errors.length > 0 && (isEditing || isMembersMode)" 
         class="mb-4 p-3 rounded-lg border"
         style="background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
      <div class="text-sm font-medium mb-1" style="color: #ef4444;">
        {{ 'groupInfoModal.validationError' | translate }}:
      </div>
      <ul class="text-sm" style="color: #ef4444;">
        <li *ngFor="let error of errors" class="flex items-start">
          <span class="mr-1">•</span>
          <span>{{ error }}</span>
        </li>
      </ul>
    </div>

    <div *ngIf="loading" class="text-center py-4 mt-16"
         style="color: var(--text-secondary);">
      {{ 'groupInfoModal.loading' | translate }}
    </div>
    <div *ngIf="error && !loading" class="text-center py-4 mt-16"
         style="color: #ef4444;">
      {{ error }}
    </div>

    <div *ngIf="groupInfo && !loading && !error" class="mt-4">
      <div class="flex justify-center mb-4">
        <div class="text-center">
          <app-avatar
            [src]="groupInfo.image"
            alt="Group Avatar"
            size="md"
            [editable]="isEditing && !isMembersMode"
            inputId="groupAvatarInput"
            (fileChange)="onAvatarChange($event)">
          </app-avatar>
          
          <div *ngIf="getImageErrors().length > 0" class="mt-2 text-xs"
               style="color: #ef4444;">
            <div *ngFor="let error of getImageErrors()">{{ error }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="!isMembersMode">
        <div class="mb-2" style="color: var(--text-primary);">
          <b>{{ 'groupInfoModal.groupName' | translate }}: </b>
          <ng-container *ngIf="!isEditing; else nameEdit">{{ groupInfo.groupName }}</ng-container>
          <ng-template #nameEdit>
            <app-input
              [(ngModel)]="editableGroup.GroupName"
              name="groupName"
              [errors]="getFieldErrors('groupName')"
              placeholder="'groupInfoModal.groupName' | translate "
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2" style="color: var(--text-primary);">
          <b>{{'groupInfoModal.groupDescription' | translate}} :</b>
          <ng-container *ngIf="!isEditing; else descriptionEdit">{{ groupInfo.description }}</ng-container>
          <ng-template #descriptionEdit>
            <app-input
              [(ngModel)]="editableGroup.Description"
              name="description"
              [errors]="getFieldErrors('description')"
              [placeholder]="'groupInfoModal.groupDescription' | translate "
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2" *ngIf="!isEditing" style="color: var(--text-primary);">
          <b>{{'groupInfoModal.admin' | translate }}: </b> {{ groupInfo.admin }}
        </div>
      </div>

      <div class="mb-2" *ngIf="!isEditing || isMembersMode">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center">
            <b style="color: var(--text-primary);">{{'groupInfoModal.members' | translate }}:</b>
            <span class="ml-2 text-sm" style="color: var(--text-secondary);">({{ memberCountStatus }})</span>
          </div>
          <button
            *ngIf="!isEditing && !isMembersMode && groupInfo.admin === currentUserNickname"
            (click)="enterMembersMode()"
            class="transition text-sm"
            style="color: var(--accent);">
            ➕
          </button>
        </div>

        <div *ngIf="isMembersMode" class="mb-3" (click)="$event.stopPropagation()">
          <input
            type="text"
            [(ngModel)]="userSearchQuery"
            (ngModelChange)="onSearchChange($event)"
            [placeholder]="'groupInfoModal.searchUsers' | translate"
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2"
            style="background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);"
          />

          <div class="mt-2">
            <div *ngIf="userSuggestions.length > 0"
                 class="border rounded-lg max-h-40 overflow-y-auto shadow-lg"
                 style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
              <div *ngFor="let user of userSuggestions"
                   (click)="addUserToSelection(user)"
                   class="px-3 py-2 cursor-pointer flex items-center"
                   style="color: var(--text-primary);">
                <img [src]="user.image" alt="avatar" class="w-6 h-6 rounded-full mr-2" />
                <span>{{ user.nickName }}</span>
              </div>
            </div>
            
            <div *ngIf="showNotFoundMessage" 
                 class="text-sm text-center py-2"
                 style="color: var(--text-secondary);">
              {{ 'groupInfoModal.userNotFound' | translate }}
            </div>
          </div>

          <app-selected-users
            [users]="selectedUsers"
            (removeUser)="removeUserFromSelection($event)">
          </app-selected-users>

          <div *ngIf="getMemberErrors().length > 0" 
               class="mt-2 p-2 rounded-lg border"
               style="background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
            <div *ngFor="let error of getMemberErrors()" class="text-xs"
                 style="color: #ef4444;">
              {{ error }}
            </div>
          </div>
        </div>

        <app-user-list
          *ngIf="groupInfo && groupInfo.members"
          [users]="groupInfo.members"
          [adminNickname]="groupInfo.admin"
          [currentUserNickname]="currentUserNickname"
          [showRemoveButtons]="isMembersMode"
          [variant]="isMembersMode ? 'detailed' : 'simple'"
          (removeUser)="removeUserFromSelection($event)"
          (userClick)="onUserClick($event)">
        </app-user-list>
      </div>
    </div>
    
    <div *ngIf="isEditing && !isMembersMode && groupInfo?.admin === currentUserNickname" class="pt-2">
      <button
        type="button"
        (click)="deleteGroupInfo()"
        class="w-full py-3 text-sm font-semibold rounded-xl border transition-colors duration-300"
        style="border-color: #ef4444; color: #ef4444;">
        {{ 'groupInfoModal.deleteGroup' | translate }}
      </button>
    </div>
  </div>
</div>