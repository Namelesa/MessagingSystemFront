<div *ngIf="open"
     class="fixed inset-0 z-[99999] flex items-center justify-center"
     style="backdrop-filter: blur(8px); background: rgba(0,0,0,0.5);"
     (click)="onClose()">
  <div
    class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-96 max-w-md mx-4 relative z-[100000]"
    (click)="$event.stopPropagation()">
    
    
    <app-modal-header
      [title]="getModalTitle() | translate"
      [showEditButton]="!isEditing && !isMembersMode"
      [showSaveButton]="(isEditing && !isMembersMode) || isMembersMode"
      [showCancelButton]="isEditing || isMembersMode"
      [saveDisabled]="!canSave"
      (editClick)="toggleEdit()"
      (saveClick)="handleSave()"
      (cancelClick)="handleCancel()">
    </app-modal-header>

    <div *ngIf="errors.length > 0 && (isEditing || isMembersMode)" class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
      <div class="text-red-600 dark:text-red-400 text-sm font-medium mb-1">{{ 'groupInfoModal.validationError' | translate }}:</div>
      <ul class="text-red-600 dark:text-red-400 text-sm">
        <li *ngFor="let error of errors" class="flex items-start">
          <span class="mr-1">•</span>
          <span>{{ error }}</span>
        </li>
      </ul>
    </div>

    <div *ngIf="loading" class="text-center py-4 mt-16">{{ 'groupInfoModal.loading' | translate }}</div>
    <div *ngIf="error && !loading" class="text-red-500 text-center py-4 mt-16">{{ error }}</div>

    <div *ngIf="groupInfo && !loading && !error" class="mt-4">
      <div class="flex justify-center mb-4">
        <div class="text-center">
          <app-avatar
            [src]="groupInfo.image"
            alt="Group Avatar"
            size="md"
            [editable]="isEditing && !isMembersMode"
            inputId="groupAvatarInput"
            (fileChange)="onAvatarChange($event)">
          </app-avatar>
          
          <div *ngIf="getImageErrors().length > 0" class="mt-2 text-red-500 dark:text-red-400 text-xs">
            <div *ngFor="let error of getImageErrors()">{{ error }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="!isMembersMode">
        <div class="mb-2">
          <b>{{ 'groupInfoModal.groupName' | translate }}: </b>
          <ng-container *ngIf="!isEditing; else nameEdit">{{ groupInfo.groupName }}</ng-container>
          <ng-template #nameEdit>
            <app-input
              [(ngModel)]="editableGroup.GroupName"
              name="groupName"
              [errors]="getFieldErrors('groupName')"
              placeholder="'groupInfoModal.groupName' | translate "
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2">
          <b>{{'groupInfoModal.groupDescription' | translate}} :</b>
          <ng-container *ngIf="!isEditing; else descriptionEdit">{{ groupInfo.description }}</ng-container>
          <ng-template #descriptionEdit>
            <app-input
              [(ngModel)]="editableGroup.Description"
              name="description"
              [errors]="getFieldErrors('description')"
              [placeholder]="'groupInfoModal.groupDescription' | translate "
              class="mt-1 w-full">
            </app-input>
          </ng-template>
        </div>

        <div class="mb-2" *ngIf="!isEditing">
          <b>{{'groupInfoModal.admin' | translate }}: </b> {{ groupInfo.admin }}
        </div>
      </div>

      <div class="mb-2" *ngIf="!isEditing || isMembersMode">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center">
            <b>{{'groupInfoModal.members' | translate }}:</b>
            <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">({{ memberCountStatus }})</span>
          </div>
          <button
            *ngIf="!isEditing && !isMembersMode && groupInfo.admin === currentUserNickname"
            (click)="enterMembersMode()"
            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-600 transition text-sm">
            ➕
          </button>
        </div>

        <div *ngIf="isMembersMode" class="mb-3" (click)="$event.stopPropagation()">
          <input
            type="text"
            [(ngModel)]="userSearchQuery"
            (ngModelChange)="onSearchChange($event)"
            [placeholder]="'groupInfoModal.searchUsers' | translate"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          />

          <div class="mt-2">
            <div *ngIf="userSuggestions.length > 0"
                 class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg max-h-40 overflow-y-auto shadow-lg">
              <div *ngFor="let user of userSuggestions"
                   (click)="addUserToSelection(user)"
                   class="px-3 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center">
                <img [src]="user.image" alt="avatar" class="w-6 h-6 rounded-full mr-2" />
                <span class="text-gray-900 dark:text-white">{{ user.nickName }}</span>
              </div>
            </div>
            
            <div *ngIf="showNotFoundMessage" 
                 class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">
              {{ 'groupInfoModal.userNotFound' | translate }}
            </div>
          </div>

          <app-selected-users
            [users]="selectedUsers"
            (removeUser)="removeUserFromSelection($event)">
          </app-selected-users>

          <div *ngIf="getMemberErrors().length > 0" class="mt-2 p-2 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
            <div *ngFor="let error of getMemberErrors()" class="text-red-600 dark:text-red-400 text-xs">
              {{ error }}
            </div>
          </div>
        </div>

        <app-user-list
          *ngIf="groupInfo && groupInfo.members"
          [users]="groupInfo.members"
          [adminNickname]="groupInfo.admin"
          [currentUserNickname]="currentUserNickname"
          [showRemoveButtons]="isMembersMode"
          [variant]="isMembersMode ? 'detailed' : 'simple'"
          (removeUser)="removeUserFromSelection($event)"
          (userClick)="onUserClick($event)">
        </app-user-list>
      </div>
    </div>
    
    <div *ngIf="isEditing && !isMembersMode && groupInfo?.admin === currentUserNickname" class="pt-2">
      <button
        type="button"
        (click)="deleteGroupInfo()"
        class="w-full py-3 text-sm font-semibold rounded-xl border border-red-600 text-red-600 
               hover:bg-red-600 hover:text-white transition-colors duration-300 dark:border-red-500 dark:text-red-400 dark:hover:bg-red-500">
        {{ 'groupInfoModal.deleteGroup' | translate }}
      </button>
    </div>
  </div>
</div>