<aside class="w-64 h-full text-black flex flex-col"
       style="background-color: var(--bg-secondary); color: var(--text-primary);">
    <div class="p-4 flex items-center justify-between"
         style="border-color: var(--border-color);">
      <shared-search-input
        [query]="search"
        (queryChange)="onSearchQueryChange($event)"
        (clear)="clearSearching()"
        [placeholder]="'groupList.searchPlaceholder' | translate"
        (focus)="onSearchFocus()"
      ></shared-search-input>
      <button 
        class="w-10 h-10 bg-transparent border rounded-lg flex items-center justify-center transition-all duration-200 flex-shrink-0 ml-2" 
        style="border-color: var(--border-color); color: var(--text-secondary);"
        (click)="openCreateGroupModal()"
        [title]="'groupList.createGroup' | translate"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
      </button>
    </div>
  
    <div *ngIf="showCreateGroupModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeCreateGroupModal()">
      <app-toast></app-toast>
      <div class="p-8 rounded-3xl shadow-2xl w-96 max-w-md mx-4 transform transition-all duration-300 max-h-[90vh] overflow-y-auto"
           style="background-color: var(--bg-secondary);"
           (click)="$event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-6 text-center"
            style="color: var(--text-primary);">
          {{'groupList.createGroup' | translate}}
        </h2>
        
        <form (ngSubmit)="createGroup()" class="space-y-6">
          <div class="flex flex-col items-center mb-6">
            <div class="relative w-20 h-20 rounded-full flex items-center justify-center mb-4 overflow-hidden border-4 shadow-lg"
                 style="background-color: var(--bg-tertiary); border-color: var(--bg-secondary);">
              <img *ngIf="selectedImageUrl" [src]="selectedImageUrl" alt="Group Avatar" class="w-full h-full object-cover">
              <svg *ngIf="!selectedImageUrl" class="w-8 h-8" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              
              <label
                *ngIf="selectedImageUrl"
                for="fileInput"
                class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex flex-col items-center justify-center
                       text-white opacity-0 hover:opacity-100 cursor-pointer transition-opacity duration-300"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 mb-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 7h4l3-3h4l3 3h4v12H3V7z"
                  />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 13a4 4 0 01-8 0" />
                </svg>
                <span class="text-xs select-none">{{'groupList.change' | translate}}</span>
              </label>
            </div>
          </div>
    
          <app-input
            [(ngModel)]="formData.GroupName"
            name="groupName"
            [placeholder]="'groupInfoModal.groupName' | translate"
            [required]="true"
            [errors]="getFieldErrors('groupName')"
            class="mb-4"
          ></app-input>
    
          <app-input
            [(ngModel)]="formData.Description"
            name="groupDescription"
            [placeholder]="'groupInfoModal.groupDescription' | translate"
            [required]="true"
            [errors]="getFieldErrors('groupDescription')"
            class="mb-4"
          ></app-input>

          <div class="mb-2">
            <div class="relative border rounded-lg"
                 style="border-color: var(--border-color);">
              <shared-search-input
                [query]="userSearchQuery"
                (queryChange)="onUserSearchQueryChange($event)"
                (clear)="onUserClear()"
                [placeholder]="'groupInfoModal.searchUsers' | translate"
                (focus)="onUserSearchFocus()"
              ></shared-search-input>

              <div *ngIf="userSearchQuery.trim() && isUserSearchActive" 
                   class="absolute top-full left-0 right-0 border rounded-lg shadow-lg z-10 mt-1 max-h-40 overflow-y-auto"
                   style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                <ng-container *ngIf="user$ | async as user; else noUserFound">
                  <div
                    class="p-3 cursor-pointer transition flex items-center gap-3"
                    style="color: var(--text-primary);"
                    (click)="addUserToGroup(user.nickName, user.image)"
                  >
                    <img
                      [src]="user.image"
                      alt="Avatar"
                      class="w-8 h-8 rounded-full object-cover"
                    />
                    <span class="font-medium">{{ user.nickName }}</span>
                  </div>
                </ng-container>
                <ng-template #noUserFound>
                  <div class="p-3 text-center"
                       style="color: var(--text-secondary);">
                    {{'groupInfoModal.userNotFound' | translate }}
                  </div>
                </ng-template>
              </div>
            </div>

            <div *ngIf="selectedUsers.length > 0" class="mt-3">
              <div class="flex flex-wrap gap-2">
                <div
                  *ngFor="let user of selectedUsers"
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary);"
                >
                  <img
                    [src]="user.image"
                    alt="Avatar"
                    class="w-5 h-5 rounded-full object-cover"
                  />
                  <span>{{ user.nickName }}</span>
                  <button
                    type="button"
                    (click)="removeUserFromGroup(user.nickName)"
                    class="ml-1 focus:outline-none"
                    style="color: var(--accent);"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div *ngIf="getFieldErrors('groupMembers').length > 0" class="mt-2">
              <div *ngFor="let error of getFieldErrors('groupMembers')" class="text-sm"
                   style="color: #ef4444;">
                {{ error }}
              </div>
            </div>
          </div>
    
          <input
            #fileInput
            id="fileInput"
            (change)="onFileChange($event)"
            type="file"
            accept="image/*"
            name="image"
            class="hidden"
          />
          
          <button
            *ngIf="!selectedImageUrl"
            type="button"
            (click)="fileInput.click()"
            class="w-full px-6 py-4 rounded-2xl text-center mb-6 border-2 border-dashed focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-300 transform hover:scale-[1.02] font-medium"
            style="background-color: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--border-color);"
          >
            <svg class="w-5 h-5 mx-auto mb-2" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            {{'groupList.uploadAvatar' | translate }}
          </button>
      
          <button 
            type="submit" 
            class="w-full text-white font-semibold py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-offset-2 transform transition-all duration-300 hover:scale-[1.02] shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            style="background-color: var(--accent);"
          >
            {{'groupList.createGroup' | translate }}
          </button>
        </form>
      </div>
    </div>

    <ng-container *ngIf="loading$ | async; else notLoading">
      <div class="flex-grow flex items-center justify-center"
           style="color: var(--text-secondary);">
        {{ 'groupInfoModal.loading' | translate }}
      </div>
    </ng-container>

    <ng-template #notLoading>
      <ng-container *ngIf="error$ | async as error; else showChats">
        <div class="flex-grow flex items-center justify-center px-4"
             style="color: #ef4444;">
          {{'groupInfoModal.error' | translate}}: {{ error }}
        </div>
      </ng-container>
    </ng-template>

    <ng-template #showChats>
      <ul class="flex-grow overflow-y-auto">
        <ng-container *ngIf="!isSearchActive || !search.trim()">
          <li *ngIf="(chats$ | async)?.length === 0" class="p-4 text-center"
              style="color: var(--text-secondary);">
            {{ 'groupList.emptyListText' | translate }}
          </li>

          <shared-list-item
            *ngFor="let chat of chats$ | async; trackBy: trackByChat"
            [name]="getChatName(chat)"
            [image]="chat.image"
            [active]="selectedNickname === getChatName(chat)"
            (click)="onSelectGroupChat(getChatName(chat), chat.image, chat.groupId || '')"
          ></shared-list-item>
        </ng-container>

        <ng-container *ngIf="isSearchActive && search.trim()">
          <ng-container *ngIf="(filteredChats$ | async)?.length as resultCount">
            <li *ngIf="resultCount === 0" class="p-4 text-center"
                style="color: var(--text-secondary);">
              <div class="flex flex-col items-center gap-2">
                <svg class="w-8 h-8" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.664-2.447M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div>{{'groupList.notFound' | translate}} "{{ search }}"</div>
                <button 
                  (click)="clearSearching()" 
                  class="text-sm underline"
                  style="color: var(--accent);"
                >
                  {{'groupList.clearSearch' | translate}}
                </button>
              </div>
            </li>

            <shared-list-item
              *ngFor="let chat of filteredChats$ | async; trackBy: trackByChat"
              [name]="getChatName(chat)"
              [image]="chat.image"
              [active]="selectedNickname === getChatName(chat)"
              (click)="selectGroupFromSearch(chat)"
            ></shared-list-item>
          </ng-container>
        </ng-container>
      </ul>
    </ng-template>
  </aside>