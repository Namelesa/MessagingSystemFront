<div #scrollContainer (scroll)="onScroll()" class="overflow-y-auto h-full relative scroll-smooth">
  <ng-container *ngFor="let group of groupedMessages; trackBy: trackByGroup">
    <div class="flex justify-center my-4">
      <span class="inline-block px-3 py-1 rounded-full opacity-80 text-sm shadow-md"
            style="background-color: var(--bg-tertiary); color: var(--text-primary);">
        {{ isToday(group.messages[0].sendTime) ? 'Today' : (group.messages[0].sendTime | date:'d MMMM yyyy') }}
      </span>
    </div>
    <ng-container *ngFor="let msg of group.messages; let i = index; trackBy: trackByMessageId">
      <div class="flex flex-col mb-1 relative cursor-pointer message-container px-4"
           [ngClass]="isMyMessage(msg) ? 'items-end' : 'items-start'"
           [attr.data-message-id]="msg.id"
           (contextmenu)="onMessageRightClick($event, msg)">
        <div class="flex items-end gap-2 max-w-[75%]" [ngClass]="isMyMessage(msg) ? 'flex-row-reverse ml-auto' : 'flex-row mr-auto'">
          <div *ngIf="!isMyMessage(msg)" class="flex-shrink-0">
            <img [src]="getMessageAvatar(msg)" [alt]="msg.sender" class="w-8 h-8 rounded-full object-cover" />
          </div>
          <div class="relative flex-1">
            <div class="px-3 py-2 rounded-2xl shadow-sm text-sm min-w-[48px] min-h-[32px] message-block transition-all duration-300"
                 [ngClass]="[
                   isMyMessage(msg) ? 'text-white rounded-br-md' : 'rounded-bl-md',
                   isMessageHighlighted(msg.id) ? 'ring-2 ring-opacity-80 shadow-md' : ''
                 ]"
                 [style.background-color]="isMyMessage(msg) ? 'var(--accent)' : 'var(--bg-secondary)'"
                 [style.color]="isMyMessage(msg) ? '#ffffff' : 'var(--text-primary)'"
                 [style.ring-color]="isMessageHighlighted(msg.id) ? 'var(--accent)' : ''"
                 style="word-break: break-word;">
              <div *ngIf="msg.replyFor && getRepliedMessage(msg.replyFor)"
                   class="mb-2 p-2 rounded-lg border-l-2 cursor-pointer transition-colors"
                   [style.background-color]="isMyMessage(msg) ? 'rgba(255, 255, 255, 0.2)' : 'var(--bg-tertiary)'"
                   [style.border-color]="isMyMessage(msg) ? 'rgba(255, 255, 255, 0.4)' : 'var(--border-color)'"
                   (click)="scrollToMessage(msg.replyFor!)">
                <div class="flex items-center space-x-1 mb-1">
                  <svg class="w-3 h-3 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                  </svg>
                  <span class="text-xs font-medium opacity-75">{{ getRepliedMessage(msg.replyFor!)?.sender }}</span>
                </div>
                <p class="text-xs opacity-75 line-clamp-2">{{ truncateText(getRepliedMessage(msg.replyFor!)?.content || '') }}</p>
              </div>
              <div *ngIf="!isMyMessage(msg) && shouldShowSenderName(group.messages, i)" 
                   class="text-xs mb-1 text-left font-bold"
                   style="color: var(--text-primary);">
                {{ msg.sender }}
              </div>
              <div class="whitespace-pre-line break-words">{{ getMessageContent(msg) }}</div>
              <div class="flex items-center gap-1 mt-1 text-xs justify-end opacity-75">
                <span>{{ msg.sendTime | date:'shortTime' }}</span>
                <ng-container *ngIf="msg.isEdited && msg.editTime">
                  <span class="mx-1">â€¢</span>
                  <span class="italic">{{'messages.edited' | translate}} {{ msg.editTime | date:'shortTime' }}</span>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-container>

  <div *ngIf="showContextMenu"
       class="fixed border rounded-lg shadow-lg py-1 z-50 min-w-[150px]"
       style="background-color: var(--bg-primary); border-color: var(--border-color);"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       (click)="$event.stopPropagation()">
    <button class="w-full px-3 py-2 text-left text-sm flex items-center gap-2 transition-colors"
            style="color: var(--text-primary);"
            (click)="onReplyToMessage()">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
      </svg>
      {{'messages.reply' | translate}}
    </button>
    <button *ngIf="canEditOrDelete()" 
            class="w-full px-3 py-2 text-left text-sm flex items-center gap-2 transition-colors"
            style="color: var(--text-primary);"
            (click)="onEditMessage()">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
      </svg>
      {{'messages.edit' | translate}}
    </button>
    <button *ngIf="canEditOrDelete()" 
            class="w-full px-3 py-2 text-left text-sm flex items-center gap-2 transition-colors"
            style="color: #ef4444;"
            (click)="onDeleteMessage()">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
      {{'messages.delete' | translate}}
    </button>
  </div>
</div>